<!DOCTYPE html>
<html>
<head>
<!-- import library and style sheet -->
<link rel="stylesheet" href="stylesheet.css" type="text/css" charset="utf-8">
<script type="text/javascript" src="jquery-1.7.1.js"></script>
<script type="text/javascript">

/* define function */
function shuffle(o){
  for(var j,x,i=o.length;i;j=Math.floor(Math.random()*i),x = o[--i],o[i]=o[j],o[j]=x);
  return o;
}

function range(start, end, step){
	var range = [];
    var typeofStart = typeof start;
    var typeofEnd = typeof end;

	while (step > 0 ? end >= start : end <= start) {
            range.push(start);
            start += step;}
            return range
}

function padZero10(number) {
  if (number<10) { number = ("0"+number).slice(-4); }
  return number;
}

function order(array){
	var results = [];
	//all combinations of images (as pairs)
	for (let i = 0; i < array.length ; i++) {
	  for (let j = i ; j < array.length; j++) {
		results.push([array[i], array[j]]);
		}
	}
	//randomize the orders
    temp = shuffle(results)
    
    //collapse the pairs into an array (switch which one is the first at random)
    var finalorder =[]
    for (ii = 0; ii < temp.length; ii++) {
		tempNum = Math.floor(Math.random() * 2);
			if (tempNum == 0){
				finalorder.push(temp[ii][0])
				finalorder.push(temp[ii][1])
			}else{
				finalorder.push(temp[ii][1])
				finalorder.push(temp[ii][0])
			}
    } 
    return finalorder  
}

/*start coding the task*/
$(document).ready(function(){
    var starttime = new Date();
    /* define variables*/
	var ImgNum = 9;
	var TrialNum = (90+45)*2+1;/*(72+36)*2+1; /*ImgNum*2; (num of images + num questions)*2+1*/
	var Imgarray = [1,2,3,4,5,6,7,8,9];
	var ImgOrder = order(Imgarray);/*shuffle(range(0,ImgNum-1,1));*/
	var i = 0;
	var word_line1 = ["Please press keys"];
	var word_line2 = ["Same (s) or Different (d) "];
	var fileName = ["feature01_viewpoint01_1.jpg","feature01_viewpoint01_4.jpg","feature01_viewpoint01_7.jpg","feature02_viewpoint01_1.jpg","feature02_viewpoint01_4.jpg","feature02_viewpoint01_7.jpg","feature03_viewpoint01_1.jpg","feature03_viewpoint01_4.jpg","feature03_viewpoint01_7.jpg","feature03_viewpoint01_7.jpg","feature03_viewpoint01_7.jpg","feature03_viewpoint01_7.jpg"];

	var imgs = new Array(ImgNum);
	var imgCount = 0;
	var tempImgCount = 0;
	var isInRuntrial = 0;
	var data = [['']];
	var sOnset = null;
	var logcount = 0;
    var canvas = document.getElementById("myCanvas"); /*canvas ID
	in body */
	var ctx = canvas.getContext("2d");
    /*console.log(ImgOrder)*/
    
	function loadImage()
	{
		if (imgCount < ImgNum)
		{
			imgs[imgCount] = new Image();
			imgs[imgCount].src=  fileName[imgCount];
			imgs[imgCount].onload=loadImage;
			imgCount++;
		} else{   /*runTrial()*/
			StartTask(); /* after loading all the images,
	start running the experiment */
		}
	}
                  
	
	function StartTask(){
		ctx.font="20px Arial";
		ctx.fillStyle="black";
		ctx.textBaseline="middle";
		ctx.textAlign="center";
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.fillText("You will see a series of objects grouped in pairs." , canvas.width*0.5, 30);
		ctx.fillText("Each object in the pair will be presented one at a time (for 1 second) successively.", canvas.width*0.5, 70);
		ctx.fillText("You will be asked to indicate whether the two objects in a pair are different or the same.", canvas.width*0.5, 110);
		ctx.fillText("Please press key s to indicate they are the same and press key d to indicate they are different.", canvas.width*0.5, 150);
		ctx.fillText("You will have 2 seconds to respond.", canvas.width*0.5, 190);
		ctx.fillText("You will receive the confirmation code for submitting the HIT after you complete this task.", canvas.width*0.5, 230);
	    $("#startButton").show();	
	}
	
	$("#startButton").click(function() {
		$("#startButton").hide();
		runTrial()
	});
				
	function runTrial(){
	isInRuntrial = 0; /*enable button press*/
	if (i < TrialNum){
			if ((i % 2)== 0 && (i!=0)){   
					if ((i % 6)==0){
							isInRuntrial = 1; /*enable button press*/
							sOnset = new Date();
							ctx.clearRect(0, 0, canvas.width, canvas.height); /*clear your canvas*/
							ctx.font="30px Arial";
							ctx.fillStyle="black";
							ctx.textBaseline="Top";
							ctx.textAlign="center";
							ctx.fillText(word_line1, canvas.width*0.5, canvas.height *0.4);
							ctx.fillText(word_line2, canvas.width*0.5, canvas.height *0.5);
							logcount++;
							i++;
							data[logcount] = ["R:", -1, "z", 0,ImgOrder[tempImgCount-2],ImgOrder[tempImgCount-1],"R"];
							setTimeout(runTrial, 2000);
						 } else{
							ctx.clearRect(0, 0, canvas.width, canvas.height); /*clear your canvas*/
							ctx.drawImage(imgs[ImgOrder[tempImgCount]-1],50,100,800,600); /*dx, dy, dWidth, dHeight*/
							console.log(imgs[ImgOrder[tempImgCount]-1].src)
							console.log(ImgOrder[tempImgCount])
							i++;
							tempImgCount += 1;
							setTimeout(runTrial, 1000);
							}
					} else{
					ctx.clearRect(0, 0, canvas.width, canvas.height); /*clear your canvas*/
					ctx.font="60px Arial";
					ctx.fillStyle="black";
					ctx.textBaseline="Top";
					ctx.textAlign="center";
					ctx.fillText("+", canvas.width*0.5, canvas.height *0.5);
					i++;
					setTimeout(runTrial, 1000);}
				} else{
				ExpComplete()
				}
	}
	
	function ExpComplete(){
		var endtime = new Date()
		console.log(endtime-starttime)
		ctx.clearRect(0, 0, canvas.width, canvas.height); /*clear your canvas*/
		ctx.font="30px Arial";
		ctx.fillStyle="black";
		ctx.textBaseline="Top";
		ctx.textAlign="center";
		ctx.fillText("You have completed the experiment", canvas.width*0.5, canvas.height *0.4);
		/*For saving out data */
		$("#SameDifferent", opener.window.document).val(data.join(";")); /*check Menu.html -- create an inden input for this*/
		opener.updateMainMenu(2);/*go back to main menu -- check Menu.html*/
		JavaScript:window.close();/*close windows tap*/
	}
	
		$("body").keypress(function(event){
		if (isInRuntrial==1){
			var key = String.fromCharCode(event.which);
			d1 = new Date();
			var ans = -1;
			switch(key[0]){
				case 's':
					ans = 1;
					break;
				case 'd':
					ans = 0;
					break;}
			console.log(ans)
			console.log(d1.getTime()-sOnset.getTime())
			console.log(data)
			data[logcount] = ["R:", ans, key, d1.getTime() - sOnset.getTime(),ImgOrder[tempImgCount-2],ImgOrder[tempImgCount-1],"R"];
			
			}else{

			}
			/*logCount++;*/
		});

	loadImage();
});

</script>

</head>
<body>
<table>
	<tr>
		<td>
			<canvas id="myCanvas" width="900" height="600"></canvas>
			<p><button id="startButton" style="font-family: arial; color: black; font-size: 24px"> Click to start</p>
		</td>
	</tr>
</table>
</body>

</html>